<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Souyette Card Game Pocket</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f0f0f0;
    }
    header {
      background: #2c3e50;
      color: white;
      padding: 1rem;
      text-align: center;
      font-size: 1.5rem;
      position: relative;
    }
    #logout-btn {
      position: absolute;
      right: 1rem;
      top: 1rem;
      background: #c0392b;
      color: white;
      border: none;
      padding: 0.4rem 0.8rem;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9rem;
      display: none;
    }
    .tabs {
      display: flex;
      justify-content: center;
      background: #ecf0f1;
      padding: 0.5rem;
    }
    .tab-btn {
      padding: 0.5rem 1rem;
      margin: 0 0.5rem;
      border: none;
      border-radius: 5px;
      background: #bdc3c7;
      cursor: pointer;
    }
    .tab-btn.active {
      background: #3498db;
      color: white;
    }
    main {
      padding: 1rem;
      max-width: 800px;
      margin: auto;
    }
    .booster-btn {
      background: #e67e22;
      color: white;
      border: none;
      padding: 1rem;
      font-size: 1.1rem;
      border-radius: 10px;
      margin: 0.5rem 0;
      cursor: pointer;
      width: 100%;
    }
    .card-container {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: center;
      margin-top: 1rem;
    }
    .card {
      width: 100px;
      height: 140px;
      border-radius: 10px;
      background-size: cover;
      background-position: center;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      position: relative;
      cursor: pointer;
      transition: transform 0.3s ease;
    }
    .count-badge {
      position: absolute;
      bottom: 6px;
      right: 6px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      font-size: 0.75rem;
      padding: 2px 6px;
      border-radius: 10px;
    }
    .section {
      display: none;
    }
    .visible {
      display: block;
    }
    #login {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
    }
    #login input {
      font-size: 1.2rem;
      padding: 0.5rem;
      width: 150px;
      text-align: center;
      margin-bottom: 1rem;
    }
    #login button {
      font-size: 1.1rem;
      padding: 0.5rem 1rem;
      background: #27ae60;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    /* Carte agrandie lors de l'ouverture du booster */
    #booster-preview-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      flex-direction: column;
    }
    #booster-preview-overlay .card {
      width: 300px;
      height: 420px;
      border-radius: 15px;
      background-size: cover;
      background-position: center;
      box-shadow: 0 8px 20px rgba(0,0,0,0.7);
      cursor: pointer;
      transform-origin: center center;
      transform: none;
      transition: transform 0.3s ease;
      position: relative;
    }
    #booster-preview-overlay .count-badge {
      bottom: 10px;
      right: 10px;
      font-size: 1.2rem;
      padding: 6px 10px;
      border-radius: 12px;
      position: absolute;
      background: rgba(0,0,0,0.7);
      color: white;
    }
    #last-booster-summary {
      margin-top: 1rem;
      text-align: center;
    }
    #last-booster-summary h4 {
      margin-bottom: 0.5rem;
    }
    #last-booster-summary .card-container .card {
      width: 100px;
      height: 140px;
      position: relative;
      transform: scale(1);
      cursor: default;
    }
    #last-booster-summary .star-emoji {
      position: absolute;
      bottom: -18px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1.5rem;
      color: gold;
      pointer-events: none;
    }
    /* Overlay pour agrandissement carte collection */
    .overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1001;
    }
    .overlay .card.expanded {
      width: 300px; /* 3x la largeur 100px */
      height: 420px; /* 3x la hauteur 140px */
      border-radius: 15px;
      background-size: cover;
      background-position: center;
      box-shadow: 0 8px 20px rgba(0,0,0,0.7);
      cursor: pointer;
      position: relative;
      transition: transform 0.3s ease;
    }
    .overlay .count-badge {
      bottom: 10px;
      right: 10px;
      font-size: 1.2rem;
      padding: 6px 10px;
      border-radius: 12px;
      position: absolute;
      background: rgba(0,0,0,0.7);
      color: white;
    }
    /* Timer style */
    #next-booster-timer {
      font-weight: bold;
      color: #c0392b;
      margin-top: 0.3rem;
      text-align: center;
    }
  </style>
</head>
<body>
  <header>
    Souyette Card Game Pocket
    <button id="logout-btn" onclick="logout()">D√©connexion</button>
  </header>

  <div id="login" class="section visible">
    <h2>Entrez votre code √† 6 chiffres</h2>
    <input type="text" id="codeInput" maxlength="6" placeholder="Ex: 123456" />
    <button onclick="login()">Connexion</button>
  </div>

  <div id="app" style="display: none;">
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('booster')">Booster</button>
      <button class="tab-btn" onclick="switchTab('collection')">Collection</button>
    </div>

    <main>
      <section id="booster" class="section visible">
        <p>Boosters restants aujourd'hui : <span id="booster-count">3</span></p>
        <p id="next-booster-timer"></p>
        <button class="booster-btn" onclick="openBooster('OG')">üéÅ Ouvrir un booster Extension OG</button>
        <button class="booster-btn" onclick="openBooster('PR')">üéÅ Ouvrir un booster Extension PR</button>
        <div id="booster-result" class="card-container"></div>

        <!-- R√©sum√© dernier booster -->
        <div id="last-booster-summary" style="display:none;">
          <h4>R√©sum√© du dernier booster</h4>
          <div class="card-container" id="last-booster-cards"></div>
        </div>
      </section>

      <section id="collection" class="section">
        <h3>Votre Collection</h3>
        <div id="collection-extensions"></div>
      </section>
    </main>
  </div>

  <!-- Overlay carte agrandie booster -->
  <div id="booster-preview-overlay" style="display:none;"></div>

  <script>
  const cardsPerBooster = 5;
  const boosterIntervalMs = 8 * 60 * 60 * 1000; // 8 heures
  const maxBoosters = 3;
  let currentCode = "";

  const extensions = {
    OG: Array.from({ length: 125 }, (_, i) => `images/OG/${String(i + 1).padStart(3, '0')}.png`),
    PR: Array.from({ length: 125 }, (_, i) => `images/PR/${String(i + 1).padStart(3, '0')}.png`)
  };

  // --- UTILITAIRES ---

  function saveData(code, data) {
    localStorage.setItem("scgp_" + code, JSON.stringify(data));
  }

  function loadData(code) {
    const d = localStorage.getItem("scgp_" + code);
    if (d) return JSON.parse(d);
    return { boosterTimestamps: [], boostersOpenedToday: 0, collection: { OG: {}, PR: {} }, lastBooster: null };
  }

  // Calcul combien de boosters disponibles en fonction des timestamps et max 3
  function getAvailableBoosters(data) {
    const now = Date.now();
    const boostersUsed = data.boosterTimestamps.length;
    if (boostersUsed === 0) return maxBoosters; // au d√©but 3 boosters dispo (pas encore ouverts)
    const oldest = data.boosterTimestamps[0];
    const elapsed = now - oldest;
    const gained = Math.floor(elapsed / boosterIntervalMs);
    return Math.min(maxBoosters, boostersUsed + gained);
  }

  // --- AUTH ---

  function login() {
    const code = document.getElementById("codeInput").value.trim();
    if (!/^\d{6}$/.test(code)) {
      alert("Veuillez entrer un code √† 6 chiffres valide.");
      return;
    }
    currentCode = code;
    document.getElementById("login").style.display = "none";
    document.getElementById("app").style.display = "block";
    document.getElementById("logout-btn").style.display = "inline-block";

    loadAndRender();
    startTimers();
  }

  function logout() {
    currentCode = "";
    document.getElementById("login").style.display = "flex";
    document.getElementById("app").style.display = "none";
    document.getElementById("logout-btn").style.display = "none";
    clearInterval(timerInterval);
  }

  // --- UI ---

  function switchTab(tab) {
    document.querySelectorAll(".tab-btn").forEach(btn => btn.classList.remove("active"));
    document.querySelectorAll(".section").forEach(sec => sec.classList.remove("visible"));

    if (tab === "booster") {
      document.querySelector(".tab-btn:nth-child(1)").classList.add("active");
      document.getElementById("booster").classList.add("visible");
    } else if (tab === "collection") {
      document.querySelector(".tab-btn:nth-child(2)").classList.add("active");
      document.getElementById("collection").classList.add("visible");
      renderCollection();
    }
  }

  // --- BOOSTERS ---

  // Ouvrir un booster d‚Äôune extension
  function openBooster(extension) {
    if (!currentCode) return;

    const data = loadData(currentCode);
    const available = getAvailableBoosters(data);

    if (available <= 0) {
      alert("Aucun booster disponible pour le moment. Patientez un peu.");
      return;
    }

    if (data.boosterTimestamps.length >= maxBoosters) {
      // Supprimer le plus ancien timestamp car on atteint la limite max
      data.boosterTimestamps.shift();
    }

    data.boosterTimestamps.push(Date.now());
    data.boostersOpenedToday = (data.boostersOpenedToday || 0) + 1;

    // Tirage des cartes du booster
    const cards = [];
    for (let i = 0; i < cardsPerBooster; i++) {
      const randIndex = Math.floor(Math.random() * extensions[extension].length);
      cards.push({ extension, image: extensions[extension][randIndex] });
    }

    // Ajouter cartes √† la collection
    cards.forEach(card => {
      const extColl = data.collection[card.extension];
      extColl[card.image] = (extColl[card.image] || 0) + 1;
    });

    data.lastBooster = cards;

    saveData(currentCode, data);
    renderBoosterResult(cards);
    updateBoosterCount();
    updateNextBoosterTimer(data);
  }

  // Affiche le booster ouvert
  function renderBoosterResult(cards) {
    const container = document.getElementById("booster-result");
    container.innerHTML = "";
    cards.forEach(card => {
      const div = document.createElement("div");
      div.className = "card";
      div.style.backgroundImage = `url(${card.image})`;
      // Badge nombre dans la collection
      const count = loadData(currentCode).collection[card.extension][card.image] || 1;
      const badge = document.createElement("div");
      badge.className = "count-badge";
      badge.textContent = count;
      div.appendChild(badge);

      div.onclick = () => expandCard(card.image, count);
      container.appendChild(div);
    });

    // Afficher r√©sum√© du dernier booster
    const summary = document.getElementById("last-booster-summary");
    const summaryCards = document.getElementById("last-booster-cards");
    summaryCards.innerHTML = "";
    const data = loadData(currentCode);
    if (data.lastBooster) {
      data.lastBooster.forEach(card => {
        const div = document.createElement("div");
        div.className = "card";
        div.style.backgroundImage = `url(${card.image})`;
        const count = data.collection[card.extension][card.image] || 1;
        const badge = document.createElement("div");
        badge.className = "count-badge";
        badge.textContent = count;
        div.appendChild(badge);

        // √âtoiles pour raret√©, exemple arbitraire
        if (Math.random() < 0.1) {
          const star = document.createElement("div");
          star.className = "star-emoji";
          star.textContent = "‚≠ê";
          div.appendChild(star);
        }
        summaryCards.appendChild(div);
      });
      summary.style.display = "block";
    } else {
      summary.style.display = "none";
    }
  }

  // --- COLLECTION ---

  function renderCollection() {
    if (!currentCode) return;
    const data = loadData(currentCode);
    const container = document.getElementById("collection-extensions");
    container.innerHTML = "";

    Object.keys(extensions).forEach(ext => {
      const section = document.createElement("section");
      section.innerHTML = `<h4>Extension ${ext}</h4>`;
      const cardsDiv = document.createElement("div");
      cardsDiv.className = "card-container";

      Object.entries(data.collection[ext]).forEach(([image, count]) => {
        if (count > 0) {
          const div = document.createElement("div");
          div.className = "card";
          div.style.backgroundImage = `url(${image})`;
          const badge = document.createElement("div");
          badge.className = "count-badge";
          badge.textContent = count;
          div.appendChild(badge);
          div.onclick = () => expandCard(image, count);
          cardsDiv.appendChild(div);
        }
      });

      section.appendChild(cardsDiv);
      container.appendChild(section);
    });
  }

  // --- CARTE AGRANDIE ---

  function expandCard(image, count) {
    const overlay = document.createElement("div");
    overlay.className = "overlay";
    const card = document.createElement("div");
    card.className = "card expanded";
    card.style.backgroundImage = `url(${image})`;
    const badge = document.createElement("div");
    badge.className = "count-badge";
    badge.textContent = count;
    card.appendChild(badge);
    overlay.appendChild(card);

    overlay.onclick = () => {
      document.body.removeChild(overlay);
    };

    document.body.appendChild(overlay);
  }

  // --- TIMER & MISE √Ä JOUR ---

  function updateBoosterCount() {
    const data = loadData(currentCode);
    const available = getAvailableBoosters(data);
    document.getElementById("booster-count").textContent = available;
  }

  function updateNextBoosterTimer(data) {
    const container = document.getElementById("next-booster-timer");
    const now = Date.now();
    const available = getAvailableBoosters(data);

    if (available >= maxBoosters) {
      container.textContent = "Booster max atteint.";
      return;
    }

    // Si pas encore de booster ouvert, le prochain booster sera dans 8h apr√®s le "d√©but" (ici maintenant)
    if (data.boosterTimestamps.length === 0) {
      container.textContent = "Prochain booster dans : 08:00:00";
      return;
    }

    const firstTimestamp = data.boosterTimestamps[0];

    // On calcule le prochain palier : si 0 boosters, on attend 1, si 1 on attend 2, etc.
    const nextBoosterIndex = available; // 0->1, 1->2, 2->3
    const nextTime = firstTimestamp + boosterIntervalMs * (nextBoosterIndex + 1);
    const diff = Math.max(0, nextTime - now);

    function format(ms) {
      const h = Math.floor(ms / 3600000);
      const m = Math.floor((ms % 3600000) / 60000);
      const s = Math.floor((ms % 60000) / 1000);
      return `${h.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
    }

    if (diff <= 0) {
      container.textContent = "Nouveau booster disponible !";
    } else {
      container.textContent = `Prochain booster dans : ${format(diff)}`;
    }
  }

  let timerInterval;
  function startTimers() {
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(() => {
      if (!currentCode) return;
      const data = loadData(currentCode);
      updateBoosterCount();
      updateNextBoosterTimer(data);
    }, 1000);
  }

  // --- INITIAL LOAD & START ---

  function loadAndRender() {
    if (!currentCode) return;
    const data = loadData(currentCode);
    updateBoosterCount();
    updateNextBoosterTimer(data);
    renderCollection();
  }

  </script>
</body>
</html>
