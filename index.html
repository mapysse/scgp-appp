<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Souyette Card Game Pocket</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f0f0f0;
    }
    header {
      background: #2c3e50;
      color: white;
      padding: 1rem;
      text-align: center;
      font-size: 1.5rem;
      position: relative;
    }
    #logout-btn {
      position: absolute;
      right: 1rem;
      top: 1rem;
      background: #c0392b;
      color: white;
      border: none;
      padding: 0.4rem 0.8rem;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9rem;
      display: none;
    }
    .tabs {
      display: flex;
      justify-content: center;
      background: #ecf0f1;
      padding: 0.5rem;
    }
    .tab-btn {
      padding: 0.5rem 1rem;
      margin: 0 0.5rem;
      border: none;
      border-radius: 5px;
      background: #bdc3c7;
      cursor: pointer;
    }
    .tab-btn.active {
      background: #3498db;
      color: white;
    }
    main {
      padding: 1rem;
      max-width: 800px;
      margin: auto;
    }
    .booster-btn {
      background: #e67e22;
      color: white;
      border: none;
      padding: 1rem;
      font-size: 1.1rem;
      border-radius: 10px;
      margin: 0.5rem 0;
      cursor: pointer;
      width: 100%;
    }
    .card-container {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: center;
      margin-top: 1rem;
    }
    .card {
      width: 100px;
      height: 140px;
      border-radius: 10px;
      background-size: cover;
      background-position: center;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      position: relative;
      cursor: pointer;
      user-select: none;
    }
    .count-badge {
      position: absolute;
      bottom: 6px;
      right: 6px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      font-size: 0.75rem;
      padding: 2px 6px;
      border-radius: 10px;
      display: none;
      user-select: none;
    }
    .card.expanded .count-badge {
      display: block;
    }
    .section {
      display: none;
    }
    .visible {
      display: block;
    }
    #login {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
    }
    #login input {
      font-size: 1.2rem;
      padding: 0.5rem;
      width: 150px;
      text-align: center;
      margin-bottom: 1rem;
    }
    #login button {
      font-size: 1.1rem;
      padding: 0.5rem 1rem;
      background: #27ae60;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .overlay .card {
      width: 300px;
      height: 420px;
      cursor: pointer;
      border-radius: 10px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.5);
      background-size: cover;
      background-position: center;
      position: relative;
      user-select: none;
      animation: zoomIn 0.3s ease forwards;
    }
    @keyframes zoomIn {
      from {
        transform: scale(0.5);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }
    @keyframes zoomOut {
      to {
        transform: scale(0.5);
        opacity: 0;
      }
    }
    @keyframes boosterReveal {
      0% {
        transform: scale(0.5) rotate(-10deg);
        opacity: 0;
      }
      60% {
        transform: scale(1.05) rotate(2deg);
        opacity: 1;
      }
      100% {
        transform: scale(1) rotate(0);
      }
    }
    .card.reveal {
      animation: boosterReveal 0.6s ease-out;
      z-index: 1;
    }
    #countdown {
      font-weight: bold;
      margin-top: 6px;
      text-align: center;
      color: #c0392b;
    }
    #last-booster-summary {
      margin-top: 1rem;
    }
    #last-booster-summary h4 {
      text-align: center;
      margin-bottom: 0.5rem;
    }
    #last-booster-summary .card-container .card.new-card::after {
      content: "‚≠ê";
      position: absolute;
      top: 6px;
      left: 6px;
      font-size: 1.3rem;
      color: gold;
      text-shadow: 0 0 3px black;
      pointer-events: none;
      user-select: none;
    }
  </style>
</head>
<body>
  <header>
    Souyette Card Game Pocket
    <button id="logout-btn" onclick="logout()">D√©connexion</button>
  </header>

  <div id="login" class="section visible">
    <h2>Entrez votre code √† 6 chiffres</h2>
    <input type="text" id="codeInput" maxlength="6" placeholder="Ex: 123456" />
    <button onclick="login()">Connexion</button>
  </div>

  <div id="app" style="display: none;">
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('booster')">Booster</button>
      <button class="tab-btn" onclick="switchTab('collection')">Collection</button>
    </div>

    <main>
      <section id="booster" class="section visible">
        <p>Boosters restants aujourd'hui : <span id="booster-count">3</span></p>
        <div id="countdown"></div>
        <button class="booster-btn" onclick="startBoosterOpening('OG')">üéÅ Ouvrir un booster Extension OG</button>
        <button class="booster-btn" onclick="startBoosterOpening('PR')">üéÅ Ouvrir un booster Extension PR</button>

        <div id="booster-overlay-container"></div>

        <div id="last-booster-summary" style="display:none;">
          <h4>R√©sum√© du dernier booster</h4>
          <div id="last-booster-cards" class="card-container"></div>
        </div>
      </section>

      <section id="collection" class="section">
        <h3>Votre Collection</h3>
        <div id="collection-extensions"></div>
      </section>
    </main>
  </div>

  <script>
    const boosterMax = 3;
    const boosterCooldown = 8 * 60 * 60 * 1000; // 8h en ms
    const cardsPerBooster = 5;
    let currentCode = "";
    let lastOpenedBoosterCards = [];
    let currentOpenIndex = 0;

    const extensions = {
      OG: Array.from({ length: 125 }, (_, i) => `images/OG/${String(i + 1).padStart(3, '0')}.jpg`),
      PR: Array.from({ length: 65 }, (_, i) => `images/PR/${String(i + 1).padStart(3, '0')}.jpg`),
    };

    function getStorageKey() {
      return `cardData_user_${currentCode}`;
    }

    function getData() {
      let data = JSON.parse(localStorage.getItem(getStorageKey())) || {};
      data.openTimestamps = data.openTimestamps || [];
      data.collection = data.collection || [];
      return data;
    }

    function saveData(data) {
      localStorage.setItem(getStorageKey(), JSON.stringify(data));
    }

    function getAvailableBoosters() {
      const data = getData();
      const now = Date.now();

      // Nettoyer timestamps trop vieux (> 3*8h = 24h)
      data.openTimestamps = data.openTimestamps.filter(ts => now - ts < boosterCooldown * boosterMax);
      saveData(data);

      // Calcul des cr√©dits
      const timestampsCount = data.openTimestamps.length;

      if (timestampsCount === 0) return boosterMax;

      const oldestTimestamp = Math.min(...data.openTimestamps);
      const elapsed = now - oldestTimestamp;

      // Nombre de cr√©dits r√©cup√©r√©s depuis le plus vieux timestamp
      const recoveredCredits = Math.floor(elapsed / boosterCooldown);

      const available = Math.min(boosterMax, timestampsCount < boosterMax ? (boosterMax - timestampsCount + recoveredCredits) : boosterMax);

      return available;
    }

    function updateBoosterCount() {
      const available = getAvailableBoosters();
      const countEl = document.getElementById("booster-count");
      countEl.textContent = available;

      if (available < boosterMax) {
        startCountdown();
      } else {
        stopCountdown();
        const countdownEl = document.getElementById("countdown");
        if (countdownEl) countdownEl.textContent = "";
      }
    }

    let countdownInterval = null;

    function startCountdown() {
      stopCountdown();

      const countdownEl = document.getElementById("countdown");

      countdownInterval = setInterval(() => {
        const data = getData();
        const now = Date.now();

        if (data.openTimestamps.length === 0) {
          countdownEl.textContent = "";
          stopCountdown();
          updateBoosterCount();
          return;
        }

        // Trier timestamps
        data.openTimestamps.sort();

        // Prochaine ouverture possible : 8h apr√®s le plus ancien timestamp
        const nextAvailable = data.openTimestamps[0] + boosterCooldown;
        const diff = nextAvailable - now;

        if (diff <= 0) {
          // On lib√®re un booster
          data.openTimestamps.shift();
          saveData(data);
          updateBoosterCount();
          return;
        }

        const h = Math.floor(diff / 3600000);
        const m = Math.floor((diff % 3600000) / 60000);
        const s = Math.floor((diff % 60000) / 1000);

        countdownEl.textContent = `Prochain booster dans : ${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
      }, 1000);
    }

    function stopCountdown() {
      if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
    }

    function login() {
      const codeInput = document.getElementById("codeInput");
      const code = codeInput.value.trim();

      if (!/^\d{6}$/.test(code)) {
        alert("Veuillez entrer un code √† 6 chiffres valide.");
        return;
      }
      currentCode = code;
      document.getElementById("login").style.display = "none";
      document.getElementById("app").style.display = "block";
      document.getElementById("logout-btn").style.display = "block";
      loadCollection();
      updateBoosterCount();
      showLastBoosterSummary();
    }

    function logout() {
      currentCode = "";
      document.getElementById("login").style.display = "flex";
      document.getElementById("app").style.display = "none";
      document.getElementById("logout-btn").style.display = "none";
      lastOpenedBoosterCards = [];
      currentOpenIndex = 0;
    }

    function switchTab(tabName) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');

      document.querySelectorAll('.section').forEach(sec => sec.classList.remove('visible'));
      document.getElementById(tabName).classList.add('visible');
    }

    function loadCollection() {
      const data = getData();
      const container = document.getElementById("collection-extensions");
      container.innerHTML = "";

      for (const ext in extensions) {
        const extDiv = document.createElement("div");
        extDiv.innerHTML = `<h4>Extension ${ext}</h4>`;
        const cardsDiv = document.createElement("div");
        cardsDiv.className = "card-container";

        extensions[ext].forEach((img, idx) => {
          const cardDiv = document.createElement("div");
          cardDiv.className = "card";
          cardDiv.style.backgroundImage = `url('${img}')`;
          if (data.collection.includes(img)) {
            cardDiv.classList.add("expanded");
          } else {
            cardDiv.style.filter = "grayscale(90%)";
          }
          cardsDiv.appendChild(cardDiv);
        });

        extDiv.appendChild(cardsDiv);
        container.appendChild(extDiv);
      }
    }

    function startBoosterOpening(extension) {
      const available = getAvailableBoosters();
      if (available <= 0) {
        alert("Vous devez attendre avant d'ouvrir un nouveau booster.");
        return;
      }

      // Ajouter timestamp ouverture
      const data = getData();
      data.openTimestamps.push(Date.now());
      saveData(data);
      updateBoosterCount();

      // G√©n√©rer 5 cartes al√©atoires non r√©p√©t√©es
      lastOpenedBoosterCards = [];
      const extCards = extensions[extension];
      const dataCollection = getData().collection;

      while (lastOpenedBoosterCards.length < cardsPerBooster) {
        const candidate = extCards[Math.floor(Math.random() * extCards.length)];
        // √©viter doublons dans ce booster
        if (!lastOpenedBoosterCards.includes(candidate)) lastOpenedBoosterCards.push(candidate);
      }

      currentOpenIndex = 0;
      showCardOverlay(lastOpenedBoosterCards[currentOpenIndex]);
    }

    function showCardOverlay(imgUrl) {
      const overlayContainer = document.getElementById("booster-overlay-container");
      overlayContainer.innerHTML = "";

      const overlay = document.createElement("div");
      overlay.className = "overlay";

      const cardDiv = document.createElement("div");
      cardDiv.className = "card expanded";
      cardDiv.style.backgroundImage = `url('${imgUrl}')`;
      cardDiv.title = "Cliquez pour voir la carte suivante";

      cardDiv.onclick = () => {
        currentOpenIndex++;
        if (currentOpenIndex >= lastOpenedBoosterCards.length) {
          // Fin du booster : fermer overlay et afficher r√©sum√©
          overlayContainer.innerHTML = "";
          addToCollection(lastOpenedBoosterCards);
          showLastBoosterSummary();
        } else {
          showCardOverlay(lastOpenedBoosterCards[currentOpenIndex]);
        }
      };

      overlay.appendChild(cardDiv);
      overlayContainer.appendChild(overlay);
    }

    function addToCollection(cards) {
      const data = getData();
      let changed = false;
      cards.forEach(card => {
        if (!data.collection.includes(card)) {
          data.collection.push(card);
          changed = true;
        }
      });
      if (changed) saveData(data);
      loadCollection();
    }

    function showLastBoosterSummary() {
      if (lastOpenedBoosterCards.length === 0) {
        document.getElementById("last-booster-summary").style.display = "none";
        return;
      }
      const summaryDiv = document.getElementById("last-booster-summary");
      const container = document.getElementById("last-booster-cards");
      container.innerHTML = "";
      const data = getData();

      lastOpenedBoosterCards.forEach(cardUrl => {
        const cardDiv = document.createElement("div");
        cardDiv.className = "card";
        cardDiv.style.backgroundImage = `url('${cardUrl}')`;
        // Marquer les cartes jamais obtenues auparavant avec une √©toile
        if (!data.collection.includes(cardUrl)) {
          cardDiv.classList.add("new-card");
        }
        container.appendChild(cardDiv);
      });

      summaryDiv.style.display = "block";
    }

    // Init
    document.getElementById("codeInput").addEventListener("keyup", e => {
      if (e.key === "Enter") login();
    });

  </script>
</body>
</html>
