<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>SCG Pocket</title>
    <style>
        body {
            font-family: 'Inter', Arial, sans-serif; /* Utilisation de la police Inter */
            margin: 0;
            background: #f0f0f0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        header {
            background: #2c3e50;
            color: white;
            padding: 1rem;
            text-align: center;
            font-size: 1.5rem;
            position: relative;
            border-bottom-left-radius: 10px; /* Coins arrondis */
            border-bottom-right-radius: 10px; /* Coins arrondis */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* Ombre douce */
        }
        #logout-btn {
            position: absolute;
            right: 1rem;
            top: 1rem;
            background: #FFFFFF;
            color: #2c3e50; /* Couleur du texte du bouton */
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 8px; /* Coins plus arrondis */
            cursor: pointer;
            font-size: 0.9rem;
            display: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: background 0.3s ease, transform 0.2s ease;
        }
        #logout-btn:hover {
            background: #e0e0e0;
            transform: translateY(-2px);
        }
        .tabs {
            display: flex;
            justify-content: center;
            background: #f8f8f8;
            border-bottom: 1px solid #ddd;
            padding: 0.5rem 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
        }
        .tab-btn {
            background: none;
            border: none;
            padding: 0.8rem 1.5rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #555;
            transition: color 0.3s ease, background 0.3s ease;
            border-radius: 5px;
            margin: 0 5px;
        }
        .tab-btn:hover {
            color: #2c3e50;
            background: #eee;
        }
        .tab-btn.active {
            color: white;
            background: #3498db;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        main {
            flex-grow: 1; /* Prend l'espace restant */
            padding: 1rem;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Aligne le contenu en haut */
        }

        .section {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 900px; /* Largeur maximale pour le contenu principal */
            margin: 0 auto; /* Centrer le bloc */
            display: none; /* Masqué par défaut, géré par JS */
        }
        .section.active {
            display: block;
        }
        
        #login {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80vh; /* Pour centrer le formulaire sur la page de connexion */
            text-align: center;
        }
        #login-form {
            background: white;
            padding: 2.5rem;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 100%;
        }
        #login-form h2 {
            margin-bottom: 1.5rem;
            color: #333;
        }
        #user-code {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 1rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            text-align: center;
        }
        #login-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1rem;
            width: 100%;
            transition: background 0.3s ease, transform 0.2s ease;
        }
        #login-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        h2 {
            color: #333;
            margin-top: 0;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .booster-section {
            text-align: center;
        }

        .booster-section p {
            font-size: 1.1rem;
            color: #555;
            margin-bottom: 20px;
        }

        .booster-buttons-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap; /* Permet aux boosters de passer à la ligne */
            gap: 20px; /* Espace entre les boosters */
            margin-top: 20px;
        }

        .booster-wrapper {
            width: 150px; /* Taille fixe pour le booster */
            height: 200px; /* Hauteur fixe pour le booster */
            perspective: 1000px; /* Pour l'effet 3D au survol */
            cursor: pointer;
            transition: transform 0.3s ease;
            position: relative;
        }

        .booster-wrapper:hover {
            transform: translateY(-5px); /* Léger soulèvement au survol */
        }

        .booster-image-actual {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.5s ease; /* Pour l'effet 3D */
            transform-style: preserve-3d;
        }

        .booster-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1rem;
            margin-top: 20px;
            transition: background 0.3s ease, transform 0.2s ease;
        }
        .booster-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        .booster-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        /* Styles pour l'overlay de prévisualisation des boosters */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none; /* Masqué par défaut */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #booster-preview-overlay .card {
            width: 250px; /* Taille des cartes dans l'animation d'ouverture */
            height: 350px;
            margin: 0 10px;
            background-size: cover;
            background-position: center;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
            transform: translateY(20px); /* Légèrement en dessous pour l'animation */
            opacity: 0;
            cursor: pointer;
            transition: transform 0.5s ease-out, opacity 0.5s ease-out;
            position: relative; /* Pour le badge et l'étoile */
        }

        #booster-preview-overlay .card.show {
            transform: translateY(0);
            opacity: 1;
        }

        #booster-result-container {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        #booster-result-container h3 {
            text-align: center;
            color: #333;
            margin-bottom: 15px;
        }

        #last-booster-summary {
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        #last-booster-summary h3 {
            text-align: center;
            margin-bottom: 15px;
            color: #333;
        }

        .card-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px; /* Espacement entre les cartes */
            justify-content: center;
        }

        .card {
            width: 120px; /* Taille standard des cartes dans la collection */
            height: 170px;
            background-size: cover;
            background-position: center;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative; /* Pour le badge et l'étoile */
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25);
        }

        .count-badge {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: #e74c3c;
            color: white;
            font-size: 0.7rem;
            padding: 3px 6px;
            border-radius: 50%; /* Cercle */
            min-width: 15px; /* Pour un chiffre unique */
            text-align: center;
            line-height: 15px; /* Centrer verticalement */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            font-weight: bold;
        }

        .star-emoji {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.5rem; /* Taille de l'étoile */
            text-shadow: 0 0 5px rgba(255, 255, 0, 0.7); /* Effet brillant */
            display: none; /* Affiché par JS pour les nouvelles cartes */
        }

        /* Styles pour l'overlay de la carte agrandie */
        #full-card-overlay .card.expanded {
            width: 300px; /* Taille de la carte agrandie */
            height: 420px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
            cursor: default; /* Plus de curseur de pointeur */
            transform: scale(1); /* Réinitialise le transform pour la transition de slide */
            transition: transform 0.3s ease-in-out; /* Pour l'animation de slide */
        }
        #full-card-overlay .card.expanded img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 15px; /* S'assurer que l'image a les coins arrondis */
            display: block; /* Supprime l'espace sous l'image */
        }
        #full-card-overlay .card.expanded .count-badge {
            font-size: 1rem;
            padding: 5px 10px;
            min-width: 20px;
            line-height: 20px;
        }

        /* Effet "Shiny" */
        .card.shiny-card::before, .booster-wrapper.shiny::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(255, 255, 255, 0.2) 30%,
                rgba(255, 255, 255, 0.5) 50%,
                rgba(255, 255, 255, 0.2) 70%,
                transparent 100%
            );
            transform: translateX(-100%); /* Commence hors de vue à gauche */
            animation: shiny-sweep 2.5s infinite linear; /* Anime le balayage */
            mix-blend-mode: screen; /* Pour que l'effet se mélange bien avec l'image */
            pointer-events: none; /* Pour ne pas interférer avec les clics */
            border-radius: 10px; /* Pour correspondre au bord de la carte/booster */
        }

        /* Keyframe pour l'animation du balayage brillant */
        @keyframes shiny-sweep {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }

        /* Animations de slide pour la carte agrandie */
        /* Ces classes seront ajoutées/retirées par JS */
        .slide-enter-active, .slide-leave-active {
            transition: transform 0.3s ease-in-out;
        }
        .slide-enter-from-right {
            transform: translateX(100%);
        }
        .slide-leave-to-left {
            transform: translateX(-100%);
        }
        .slide-enter-from-left {
            transform: translateX(-100%);
        }
        .slide-leave-to-right {
            transform: translateX(100%);
        }


        /* Collection spécifique */
        .extension-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            background-color: #fcfcfc;
        }
        .extension-section h3 {
            text-align: center;
            margin-top: 0;
            color: #444;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }


        /* Shop */
        #shop-message {
            text-align: center;
            margin-bottom: 20px;
            font-style: italic;
            color: #666;
        }
        #daily-shop-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        #daily-shop-cards .card {
            width: 140px; /* Cartes un peu plus grandes dans la boutique */
            height: 200px;
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.15);
        }
        .card.selected-for-purchase {
            border: 4px solid #3498db; /* Bordure bleue pour la sélection */
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.8);
        }

        #duplicate-selection-area {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        #duplicate-selection-area h3 {
            text-align: center;
            color: #333;
            margin-bottom: 15px;
        }
        #duplicate-selection-area p {
            text-align: center;
            color: #555;
            margin-bottom: 15px;
        }
        #duplicate-selection-count {
            font-weight: bold;
            color: #e67e22; /* Orange pour le count */
        }
        #duplicate-selection-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            max-height: 400px; /* Limite la hauteur et rend la zone scrollable */
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .card.selected-duplicate {
            border: 4px solid #e67e22; /* Bordure orange pour les doublons sélectionnés */
            box-shadow: 0 0 15px rgba(230, 126, 34, 0.8);
        }

        #buy-shop-card-btn {
            display: block;
            width: 80%;
            max-width: 300px;
            margin: 30px auto 0;
            background: #28a745;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: background 0.3s ease, transform 0.2s ease;
        }
        #buy-shop-card-btn:hover:not(:disabled) {
            background: #218838;
            transform: translateY(-2px);
        }
        #buy-shop-card-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        /* Message Box */
        #message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        #message-box-overlay.show {
            opacity: 1;
        }
        #message-box {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        #message-box-overlay.show #message-box {
            transform: translateY(0);
            opacity: 1;
        }
        #message-box p {
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 1.5rem;
        }
        #message-box button {
            background: #3498db;
            color: white;
            border: none;
            padding: 0.7rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s ease;
        }
        #message-box button:hover {
            background: #2980b9;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            header {
                font-size: 1.2rem;
            }
            .tab-btn {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }
            .section {
                padding: 1rem;
            }
            #booster-preview-overlay .card {
                width: 200px;
                height: 280px;
            }
            .card {
                width: 100px;
                height: 140px;
            }
            #full-card-overlay .card.expanded {
                width: 250px;
                height: 350px;
            }
            #daily-shop-cards .card {
                width: 120px;
                height: 170px;
            }
        }

        @media (max-width: 480px) {
            .tabs {
                flex-wrap: wrap;
            }
            .tab-btn {
                width: 45%;
                margin: 5px 2%;
            }
            .booster-wrapper {
                width: 120px;
                height: 160px;
            }
            .booster-section p {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <header>
        SCG Pocket
        <button id="logout-btn">Déconnexion</button>
    </header>

    <main>
        <section id="login" class="section active">
            <div id="login-form">
                <h2>Connexion</h2>
                <input type="password" id="user-code" placeholder="Code à 6 chiffres" maxlength="6" />
                <button id="login-btn">Se connecter</button>
            </div>
        </section>

        <div id="app-content" style="display: none;">
            <div class="tabs">
                <button class="tab-btn active" id="booster-tab">Booster</button>
                <button class="tab-btn" id="collection-tab">Collection</button>
                <button class="tab-btn" id="shop-tab">Boutique</button>
                <button class="tab-btn" id="data-tab">Données</button>
            </div>

            <section id="booster-section" class="section active">
                <h2>Ouvrir un Booster</h2>
                <p>Boosters restants : <span id="booster-count">0</span>/3</p>
                <div class="booster-buttons-container">
                    <div class="booster-wrapper" id="open-og-booster">
                        <img class="booster-image-actual" src="./assets/boosters/og.webp" alt="Booster OG" />
                    </div>
                    <div class="booster-wrapper" id="open-pr-booster">
                        <img class="booster-image-actual" src="./assets/boosters/pr.webp" alt="Booster PR" />
                    </div>
                    <div class="booster-wrapper" id="open-te-booster">
                        <img class="booster-image-actual" src="./assets/boosters/te.webp" alt="Booster TE" />
                    </div>
                </div>

                <div id="booster-result-container">
                    <h3>Dernier Booster Ouvert</h3>
                    <div id="last-booster-summary" class="card-container">
                        </div>
                </div>
            </section>

            <section id="collection-section" class="section">
                <h2>Ma Collection</h2>
                <div id="collection-grid">
                    </div>
            </section>

            <section id="shop-section" class="section">
                <h2>Boutique du Jour</h2>
                <p id="shop-message">Achetez une carte par jour en échangeant 5 doublons différents !</p>
                <div id="daily-shop-cards" class="card-container">
                    </div>

                <div id="duplicate-selection-area">
                    <h3>Sélectionnez 5 doublons à échanger (<span id="duplicate-selection-count">0</span>/5)</h3>
                    <p>Cliquez sur les cartes que vous souhaitez échanger.</p>
                    <div id="duplicate-selection-container" class="card-container">
                        </div>
                    <button id="buy-shop-card-btn" disabled>Acheter la carte sélectionnée</button>
                </div>
            </section>

            <section id="data-section" class="section">
                <h2>Gestion des Données</h2>
                <button id="export-data-btn" class="booster-btn">Exporter mes données</button>
                <p style="margin-top: 20px;">
                    <label for="import-file">Importer des données :</label>
                    <input type="file" id="import-file" accept=".json" />
                </p>
            </section>
        </div>
    </main>

    <div id="booster-preview-overlay" class="overlay">
        </div>

    <div id="full-card-overlay" class="overlay">
        <div class="card expanded">
            <img id="full-card-image" src="" alt="Carte agrandie" />
            <div id="full-card-count-badge" class="count-badge"></div>
        </div>
    </div>

    <div id="message-box-overlay">
        <div id="message-box">
            <p id="message-box-text"></p>
            <button id="message-box-ok-btn">OK</button>
        </div>
    </div>

    <script>
        // Constantes
        const CARDS_PER_BOOSTER = 5;
        const DAILY_BOOSTER_LIMIT = 3;
        const SHOP_DAILY_CARD_COUNT = 5;
        const SHOP_NEW_CARD_CHANCE = 0.3; // 30% de chance d'obtenir une nouvelle carte dans la boutique
        const SHOP_TRADE_COST = 5; // Nombre de doublons requis pour un échange

        // Date du jour pour les réinitialisations quotidiennes
        const today = new Date().toDateString();

        // Stocke le code de l'utilisateur actuellement connecté
        let currentCode = null;

        // Références DOM
        const appContent = document.getElementById("app-content");
        const loginSection = document.getElementById("login");
        const loginBtn = document.getElementById("login-btn");
        const userCodeInput = document.getElementById("user-code");
        const logoutBtn = document.getElementById("logout-btn");

        const boosterCountSpan = document.getElementById("booster-count");
        const openOgBoosterBtn = document.getElementById("open-og-booster");
        const openPrBoosterBtn = document.getElementById("open-pr-booster");
        const openTeBoosterBtn = document.getElementById("open-te-booster");
        const boosterPreviewOverlay = document.getElementById("booster-preview-overlay");
        const lastBoosterSummary = document.getElementById("last-booster-summary");

        const boosterTab = document.getElementById("booster-tab");
        const collectionTab = document.getElementById("collection-tab");
        const shopTab = document.getElementById("shop-tab");
        const dataTab = document.getElementById("data-tab");

        const boosterSection = document.getElementById("booster-section");
        const collectionSection = document.getElementById("collection-section");
        const shopSection = document.getElementById("shop-section");
        const dataSection = document.getElementById("data-section");

        const fullCardOverlay = document.getElementById("full-card-overlay");
        const fullCardImage = document.getElementById("full-card-image");
        const fullCardCountBadge = document.getElementById("full-card-count-badge");
        const expandedCardElement = fullCardOverlay.querySelector('.card.expanded'); // La carte elle-même dans l'overlay

        const shopMessage = document.getElementById("shop-message");
        const dailyShopCardsContainer = document.getElementById("daily-shop-cards");
        const duplicateSelectionContainer = document.getElementById("duplicate-selection-container");
        const duplicateSelectionCountSpan = document.getElementById("duplicate-selection-count");
        const buyShopCardBtn = document.getElementById("buy-shop-card-btn");

        const exportDataBtn = document.getElementById("export-data-btn");
        const importFileInput = document.getElementById("import-file");

        const messageBoxOverlay = document.getElementById("message-box-overlay");
        const messageBoxText = document.getElementById("message-box-text");
        const messageBoxOkBtn = document.getElementById("message-box-ok-btn");

        // Variables d'état pour le slide
        let currentExpandedCardIndex = -1;
        let currentExpandedCardsList = []; // Contiendra toutes les cartes de la collection actuelle pour le slide

        // Variables pour la détection de glissement
        let touchStartX = 0;
        let touchEndX = 0;
        let touchStartY = 0;
        let touchEndY = 0;
        const swipeThreshold = 50; // Nombre de pixels minimum pour considérer un glissement
        const swipeMaxY = 50; // Mouvement vertical maximal pour considérer un swipe horizontal

        let mouseStartX = 0;
        let mouseEndX = 0;
        let isMouseDown = false;


        // Génération des chemins d'images pour les extensions
        const extensions = {
            OG: Array.from({ length: 15 }, (_, i) => `./assets/cards/OG/${i + 1}.webp`),
            PR: Array.from({ length: 15 }, (_, i) => `./assets/cards/PR/${i + 1}.webp`),
            TE: Array.from({ length: 15 }, (_, i) => `./assets/cards/TE/${i + 1}.webp`)
        };

        // Liste des cartes "shiny" (à ajuster avec vos chemins exacts si besoin)
        const SHINY_CARDS_PATHS = [
            './assets/cards/OG/5.webp',
            './assets/cards/OG/10.webp',
            './assets/cards/OG/15.webp',
            './assets/cards/PR/5.webp',
            './assets/cards/PR/10.webp',
            './assets/cards/PR/15.webp',
            './assets/cards/TE/5.webp',
            './assets/cards/TE/10.webp',
            './assets/cards/TE/15.webp'
        ];

        // --- Fonctions utilitaires ---
        function showMessage(message) {
            messageBoxText.textContent = message;
            messageBoxOverlay.classList.add('show');
        }

        function getStorageKey() {
            return `cardData_user_${currentCode}`;
        }

        function getData() {
            if (!currentCode) return {};

            const key = getStorageKey();
            const storedData = localStorage.getItem(key);
            let data = storedData ? JSON.parse(storedData) : {};

            // Initialisation des données si elles n'existent pas
            if (!data.collection) data.collection = {};
            if (!data.boosterDailyCount) data.boosterDailyCount = DAILY_BOOSTER_LIMIT;
            if (!data.lastBooster) data.lastBooster = [];
            if (!data.shopCards) data.shopCards = [];
            if (!data.shopBoughtToday) data.shopBoughtToday = false;
            if (!data.date) data.date = today;

            // Réinitialisation quotidienne
            if (data.date !== today) {
                data.boosterDailyCount = DAILY_BOOSTER_LIMIT;
                data.shopBoughtToday = false;
                data.shopCards = generateShopCardsInternal(data.collection); // Génère de nouvelles cartes pour la boutique
                data.date = today;
            }
            saveData(data); // Sauvegarde après toute initialisation/réinitialisation
            return data;
        }

        function saveData(data) {
            if (!currentCode) return;
            localStorage.setItem(getStorageKey(), JSON.stringify(data));
        }

        // --- Fonctions Booster ---
        function updateBoosterCount() {
            const data = getData();
            boosterCountSpan.textContent = data.boosterDailyCount;
            const canOpenBooster = data.boosterDailyCount > 0;
            openOgBoosterBtn.style.opacity = canOpenBooster ? '1' : '0.5';
            openPrBoosterBtn.style.opacity = canOpenBooster ? '1' : '0.5';
            openTeBoosterBtn.style.opacity = canOpenBooster ? '1' : '0.5';

            openOgBoosterBtn.style.cursor = canOpenBooster ? 'pointer' : 'not-allowed';
            openPrBoosterBtn.style.cursor = canOpenBooster ? 'pointer' : 'not-allowed';
            openTeBoosterBtn.style.cursor = canOpenBooster ? 'pointer' : 'not-allowed';
        }

        function openBooster(extensionName) {
            const data = getData();
            if (data.boosterDailyCount <= 0) {
                showMessage("Vous avez ouvert tous vos boosters quotidiens ! Revenez demain.");
                return;
            }

            const availableCards = extensions[extensionName];
            if (!availableCards || availableCards.length === 0) {
                showMessage("Erreur: Aucune carte trouvée pour cette extension.");
                return;
            }

            const newCards = [];
            for (let i = 0; i < CARDS_PER_BOOSTER; i++) {
                const randomIndex = Math.floor(Math.random() * availableCards.length);
                const cardPath = availableCards[randomIndex];
                const isNew = !data.collection[cardPath];

                // Mettre à jour la collection
                if (data.collection[cardPath]) {
                    data.collection[cardPath].count++;
                } else {
                    data.collection[cardPath] = {
                        count: 1,
                        new: true // Marquer comme nouvelle pour l'affichage post-booster
                    };
                }
                newCards.push({ image: cardPath, isNew: isNew });
            }

            data.boosterDailyCount--;
            data.lastBooster = newCards;
            saveData(data);
            updateBoosterCount();
            showBoosterPreview();
        }

        function showBoosterPreview() {
            boosterPreviewOverlay.innerHTML = ''; // Nettoyer l'ancienne prévisualisation
            boosterPreviewOverlay.style.display = 'flex';
            lastBoosterSummary.innerHTML = ''; // Nettoyer le résumé précédent

            const data = getData();
            const cards = data.lastBooster;
            let cardIndex = 0;

            function displayNextCard() {
                if (cardIndex < cards.length) {
                    const cardData = cards[cardIndex];
                    const cardElement = document.createElement('div');
                    cardElement.className = `card ${SHINY_CARDS_PATHS.includes(cardData.image) ? 'shiny-card' : ''}`;
                    cardElement.style.backgroundImage = `url('${cardData.image}')`;
                    
                    if (cardData.isNew) {
                        const star = document.createElement('span');
                        star.className = 'star-emoji';
                        star.textContent = '⭐';
                        cardElement.appendChild(star);
                    }

                    boosterPreviewOverlay.appendChild(cardElement);

                    // Forcer le reflow pour que la transition CSS fonctionne
                    void cardElement.offsetWidth;
                    cardElement.classList.add('show');
                    cardElement.addEventListener('click', displayNextCard);
                    cardIndex++;
                } else {
                    // Toutes les cartes sont affichées, fermer l'overlay
                    setTimeout(() => {
                        boosterPreviewOverlay.style.display = 'none';
                        displayBoosterResultCards(cards);
                        updateCollection(); // Mettre à jour la collection après l'ouverture du booster
                        showLastBoosterSummary();
                    }, 500); // Attendre un peu avant de fermer
                }
            }
            displayNextCard();
        }

        function displayBoosterResultCards(cards) {
            lastBoosterSummary.innerHTML = ''; // Assurez-vous que c'est vide
            cards.forEach(cardData => {
                const cardElement = document.createElement('div');
                cardElement.className = `card ${SHINY_CARDS_PATHS.includes(cardData.image) ? 'shiny-card' : ''}`;
                cardElement.style.backgroundImage = `url('${cardData.image}')`;

                const data = getData();
                const count = data.collection[cardData.image] ? data.collection[cardData.image].count : 0;
                if (count > 1) {
                    const countBadge = document.createElement("div");
                    countBadge.className = "count-badge";
                    countBadge.textContent = count;
                    cardElement.appendChild(countBadge);
                }
                
                if (cardData.isNew) {
                    const star = document.createElement('span');
                    star.className = 'star-emoji';
                    star.textContent = '⭐';
                    cardElement.appendChild(star);
                }
                cardElement.addEventListener("click", () => {
                    // Trouver l'index de cette carte dans la liste globale currentExpandedCardsList
                    const globalIndex = currentExpandedCardsList.findIndex(c => c.image === cardData.image);
                    showFullCardOverlay(globalIndex);
                });
                lastBoosterSummary.appendChild(cardElement);
            });
        }
        
        function showLastBoosterSummary() {
            const data = getData();
            const cards = data.lastBooster || [];
            if (cards.length === 0) {
                lastBoosterSummary.innerHTML = '<p style="text-align: center; color: #777;">Ouvrez un booster pour voir vos dernières cartes !</p>';
                return;
            }
            displayBoosterResultCards(cards);
        }

        // --- Fonctions Collection ---
        function updateCollection() {
            const data = getData();
            const collection = data.collection || {};
            const collectionGrid = document.getElementById("collection-grid");
            collectionGrid.innerHTML = ""; // Nettoyer l'ancienne collection

            const sortedCardPaths = Object.keys(collection).sort((a, b) => {
                // Trie d'abord par extension
                const getExtensionCode = (path) => path.split('/')[2]; // Assuming path is like ./assets/cards/OG/1.webp
                const extA = getExtensionCode(a);
                const extB = getExtensionCode(b);

                if (extA < extB) return -1;
                if (extA > extB) return 1;

                // Ensuite par numéro de carte si même extension
                const getCardNumber = (path) => parseInt(path.match(/(\d+)\.webp$/)[1]);
                return getCardNumber(a) - getCardNumber(b);
            });

            // PRÉPAREZ LA LISTE currentExpandedCardsList ICI pour le slide
            currentExpandedCardsList = sortedCardPaths.map(imagePath => ({
                image: imagePath,
                count: collection[imagePath].count || 1
            }));

            const cardsByExtension = {};
            sortedCardPaths.forEach(imagePath => {
                const parts = imagePath.split('/');
                const extension = parts[2]; // ex: 'OG', 'PR', 'TE'
                if (!cardsByExtension[extension]) {
                    cardsByExtension[extension] = [];
                }
                cardsByExtension[extension].push({
                    image: imagePath,
                    count: collection[imagePath].count || 1
                });
            });

            Object.keys(cardsByExtension).sort().forEach(extension => {
                const extensionSection = document.createElement("div");
                extensionSection.className = "extension-section";
                
                const totalCardsInExtension = extensions[extension] ? extensions[extension].length : '??';
                const uniqueCardsInExtension = cardsByExtension[extension].length;

                extensionSection.innerHTML = `<h3>${extension} (${uniqueCardsInExtension}/${totalCardsInExtension})</h3>`;
                const extensionGrid = document.createElement("div");
                extensionGrid.className = "card-container";

                cardsByExtension[extension].forEach(card => {
                    const cardElement = document.createElement("div");
                    cardElement.className = `card ${SHINY_CARDS_PATHS.includes(card.image) ? 'shiny-card' : ''}`;
                    cardElement.style.backgroundImage = `url('${card.image}')`;
                    
                    const countBadge = document.createElement("div");
                    countBadge.className = "count-badge";
                    countBadge.textContent = card.count;
                    if (card.count <= 1) { // Cache le badge si un seul exemplaire
                        countBadge.style.display = 'none';
                    }
                    cardElement.appendChild(countBadge);

                    cardElement.addEventListener("click", () => {
                        // Trouver l'index de cette carte dans la liste globale currentExpandedCardsList
                        const globalIndex = currentExpandedCardsList.findIndex(c => c.image === card.image);
                        showFullCardOverlay(globalIndex); // Passez l'index
                    });
                    extensionGrid.appendChild(cardElement);
                });
                extensionSection.appendChild(extensionGrid);
                collectionGrid.appendChild(extensionSection);
            });
        }

        function showFullCardOverlay(index) {
            if (index < 0 || index >= currentExpandedCardsList.length) {
                console.error("Index de carte invalide pour l'overlay:", index);
                return;
            }

            currentExpandedCardIndex = index;
            const cardToShow = currentExpandedCardsList[currentExpandedCardIndex];

            fullCardImage.src = cardToShow.image;
            fullCardCountBadge.textContent = cardToShow.count;
            fullCardCountBadge.style.display = cardToShow.count > 1 ? 'block' : 'none'; // Affiche ou masque le badge

            fullCardOverlay.style.display = "flex"; // Affiche l'overlay

            // Réinitialiser les classes d'animation pour la première affichage
            expandedCardElement.classList.remove('slide-enter-from-right', 'slide-enter-from-left', 'slide-leave-to-left', 'slide-leave-to-right');
        }

        function navigateFullCard(direction) { // direction: -1 pour précédent, 1 pour suivant
            if (currentExpandedCardIndex === -1 || currentExpandedCardsList.length === 0) {
                return; // Pas de carte ouverte
            }

            const nextIndex = currentExpandedCardIndex + direction;

            if (nextIndex >= 0 && nextIndex < currentExpandedCardsList.length) {
                // Appliquer l'animation de sortie
                if (direction === 1) { // Vers la droite (carte suivante)
                    expandedCardElement.classList.add('slide-leave-to-left');
                    expandedCardElement.classList.remove('slide-enter-from-right', 'slide-enter-from-left', 'slide-leave-to-right');
                } else { // Vers la gauche (carte précédente)
                    expandedCardElement.classList.add('slide-leave-to-right');
                    expandedCardElement.classList.remove('slide-enter-from-right', 'slide-enter-from-left', 'slide-leave-to-left');
                }

                // Attendre la fin de l'animation de sortie pour changer la source
                expandedCardElement.addEventListener('transitionend', function handler() {
                    expandedCardElement.removeEventListener('transitionend', handler);

                    currentExpandedCardIndex = nextIndex;
                    const cardToShow = currentExpandedCardsList[currentExpandedCardIndex];

                    fullCardImage.src = cardToShow.image;
                    fullCardCountBadge.textContent = cardToShow.count;
                    fullCardCountBadge.style.display = cardToShow.count > 1 ? 'block' : 'none';

                    // Appliquer l'animation d'entrée
                    if (direction === 1) { // Vient de la droite
                        expandedCardElement.classList.remove('slide-leave-to-left');
                        expandedCardElement.classList.add('slide-enter-from-right');
                    } else { // Vient de la gauche
                        expandedCardElement.classList.remove('slide-leave-to-right');
                        expandedCardElement.classList.add('slide-enter-from-left');
                    }

                    // Pour nettoyer les classes d'animation après l'entrée (sinon elles restent)
                    setTimeout(() => {
                        expandedCardElement.classList.remove('slide-enter-from-right', 'slide-enter-from-left');
                    }, 300); // Doit correspondre à la durée de la transition CSS
                    
                }, { once: true }); // S'assure que l'écouteur n'est appelé qu'une seule fois
            }
        }


        // --- Fonctions Boutique ---
        function generateShopCardsInternal(userCollection) {
            const allPossibleCards = [];
            for (const ext in extensions) {
                allPossibleCards.push(...extensions[ext]);
            }

            const shopCards = [];
            const cardsNotOwned = allPossibleCards.filter(cardPath => !userCollection[cardPath]);
            
            for (let i = 0; i < SHOP_DAILY_CARD_COUNT; i++) {
                let cardPath;
                if (Math.random() < SHOP_NEW_CARD_CHANCE && cardsNotOwned.length > 0) {
                    // Tente de proposer une nouvelle carte
                    const randomIndex = Math.floor(Math.random() * cardsNotOwned.length);
                    cardPath = cardsNotOwned.splice(randomIndex, 1)[0]; // Retire la carte pour éviter les doublons dans la boutique
                } else {
                    // Propose une carte aléatoire parmi toutes les cartes possibles
                    const randomIndex = Math.floor(Math.random() * allPossibleCards.length);
                    cardPath = allPossibleCards[randomIndex];
                }
                shopCards.push(cardPath);
            }
            return shopCards;
        }

        let selectedShopCardIndex = -1;
        let selectedDuplicates = []; // Stocke les chemins des cartes doublons sélectionnées

        function updateShop() {
            const data = getData();
            dailyShopCardsContainer.innerHTML = '';
            selectedShopCardIndex = -1; // Réinitialiser la sélection
            selectedDuplicates = [];
            updateBuyButtonState();

            if (data.shopBoughtToday) {
                shopMessage.textContent = "Vous avez déjà effectué votre achat quotidien. Revenez demain !";
                dailyShopCardsContainer.innerHTML = '<p style="text-align: center; color: #777; width: 100%;">La boutique est fermée pour aujourd\'hui.</p>';
                buyShopCardBtn.disabled = true;
            } else {
                shopMessage.textContent = `Achetez une carte par jour en échangeant ${SHOP_TRADE_COST} doublons différents !`;
                data.shopCards.forEach((cardPath, index) => {
                    const cardElement = document.createElement("div");
                    cardElement.className = `card ${SHINY_CARDS_PATHS.includes(cardPath) ? 'shiny-card' : ''}`;
                    cardElement.style.backgroundImage = `url('${cardPath}')`;
                    
                    cardElement.addEventListener("click", () => selectShopCard(index));
                    dailyShopCardsContainer.appendChild(cardElement);
                });
            }
            renderDuplicatesForSelection();
        }

        function selectShopCard(index) {
            const data = getData();
            if (data.shopBoughtToday) return;

            // Désélectionner la carte précédente si elle existe
            if (selectedShopCardIndex !== -1) {
                dailyShopCardsContainer.children[selectedShopCardIndex].classList.remove("selected-for-purchase");
            }

            if (selectedShopCardIndex === index) {
                // Si la même carte est cliquée à nouveau, la désélectionner
                selectedShopCardIndex = -1;
            } else {
                // Sélectionner la nouvelle carte
                selectedShopCardIndex = index;
                dailyShopCardsContainer.children[selectedShopCardIndex].classList.add("selected-for-purchase");
            }
            updateBuyButtonState();
        }

        function renderDuplicatesForSelection() {
            const data = getData();
            duplicateSelectionContainer.innerHTML = '';
            const duplicates = Object.keys(data.collection).filter(cardPath => data.collection[cardPath].count > 1);
            
            duplicateSelectionCountSpan.textContent = selectedDuplicates.length;

            if (duplicates.length === 0) {
                duplicateSelectionContainer.innerHTML = '<p style="width: 100%; text-align: center; color: #777;">Vous n\'avez pas encore de doublons à échanger.</p>';
                return;
            }

            duplicates.forEach(cardPath => {
                // Créer une carte pour chaque doublon, et créer un nombre de badges égal au nombre de doublons
                for (let i = 0; i < data.collection[cardPath].count - 1; i++) { // -1 car on garde toujours 1 exemplaire
                    const cardElement = document.createElement("div");
                    cardElement.className = `card ${SHINY_CARDS_PATHS.includes(cardPath) ? 'shiny-card' : ''}`;
                    cardElement.style.backgroundImage = `url('${cardPath}')`;
                    
                    // Marquer comme sélectionné si déjà dans la liste
                    if (selectedDuplicates.includes(cardPath)) {
                        cardElement.classList.add("selected-duplicate");
                    }

                    // On ne peut pas avoir un badge de compte sur chaque doublon individuel ici, ça n'aurait pas de sens.
                    // Le badge de compte est sur la carte unique dans la collection.

                    cardElement.dataset.cardPath = cardPath; // Stocke le chemin pour le retrouver
                    cardElement.addEventListener("click", () => toggleDuplicateSelection(cardPath));
                    duplicateSelectionContainer.appendChild(cardElement);
                }
            });
        }

        function toggleDuplicateSelection(cardToTogglePath) {
            const currentSelectedCardElements = Array.from(duplicateSelectionContainer.children);

            if (selectedDuplicates.includes(cardToTogglePath)) {
                // Désélectionner : enlever la première occurrence de ce chemin
                const index = selectedDuplicates.indexOf(cardToTogglePath);
                if (index > -1) {
                    selectedDuplicates.splice(index, 1);
                }
                // Retirer la classe de la première carte visuelle correspondant à ce chemin qui est sélectionnée
                const selectedEl = currentSelectedCardElements.find(el => el.dataset.cardPath === cardToTogglePath && el.classList.contains('selected-duplicate'));
                if (selectedEl) selectedEl.classList.remove("selected-duplicate");

            } else {
                // Sélectionner : si la limite n'est pas atteinte
                if (selectedDuplicates.length < SHOP_TRADE_COST) {
                    selectedDuplicates.push(cardToTogglePath);
                    // Ajouter la classe à la première carte visuelle correspondant à ce chemin qui n'est PAS sélectionnée
                    const unselectedEl = currentSelectedCardElements.find(el => el.dataset.cardPath === cardToTogglePath && !el.classList.contains('selected-duplicate'));
                    if (unselectedEl) unselectedEl.classList.add("selected-duplicate");
                } else {
                    showMessage(`Vous ne pouvez sélectionner que ${SHOP_TRADE_COST} doublons.`);
                }
            }
            duplicateSelectionCountSpan.textContent = selectedDuplicates.length;
            updateBuyButtonState();
        }


        function updateBuyButtonState() {
            const data = getData();
            const shopCardSelected = selectedShopCardIndex !== -1;
            const duplicatesSelectedCount = selectedDuplicates.length;
            const canBuy = shopCardSelected && duplicatesSelectedCount === SHOP_TRADE_COST && !data.shopBoughtToday;

            buyShopCardBtn.disabled = !canBuy;

            let buttonText = "Acheter la carte sélectionnée";
            if (!shopCardSelected) {
                buttonText = "Sélectionnez une carte à acheter";
            } else if (duplicatesSelectedCount < SHOP_TRADE_COST) {
                buttonText = `Sélectionnez ${SHOP_TRADE_COST - duplicatesSelectedCount} doublons de plus`;
            } else if (data.shopBoughtToday) {
                buttonText = "Achat quotidien effectué !";
            }
            buyShopCardBtn.textContent = buttonText;
        }

        function buyShopCard() {
            const data = getData();
            if (data.shopBoughtToday) {
                showMessage("Vous avez déjà effectué votre achat quotidien. Revenez demain !");
                return;
            }
            if (selectedShopCardIndex === -1) {
                showMessage("Veuillez sélectionner une carte à acheter.");
                return;
            }
            if (selectedDuplicates.length !== SHOP_TRADE_COST) {
                showMessage(`Veuillez sélectionner exactement ${SHOP_TRADE_COST} doublons différents à échanger.`);
                return;
            }

            const cardToBuyPath = data.shopCards[selectedShopCardIndex];

            // Décrémenter les doublons utilisés
            selectedDuplicates.forEach(duplicatePath => {
                if (data.collection[duplicatePath] && data.collection[duplicatePath].count > 1) {
                    data.collection[duplicatePath].count--;
                    if (data.collection[duplicatePath].count === 0) {
                        delete data.collection[duplicatePath]; // Supprime si le count tombe à 0 (ne devrait pas arriver avec >1)
                    }
                }
            });

            // Ajouter/Inc incrémenter la carte achetée
            if (data.collection[cardToBuyPath]) {
                data.collection[cardToBuyPath].count++;
            } else {
                data.collection[cardToBuyPath] = { count: 1, new: false }; // Pas "nouvelle" au sens du booster
            }

            data.shopBoughtToday = true;
            saveData(data);
            showMessage("Achat réussi !");
            updateShop();
            updateCollection(); // La collection a changé (doublons dépensés, nouvelle carte acquise)
        }

        // --- Fonctions de Navigation ---
        let currentActiveSection = null;
        let currentActiveTabBtn = null;

        function switchTab(tabName) {
            if (currentActiveSection) {
                currentActiveSection.classList.remove("active");
            }
            if (currentActiveTabBtn) {
                currentActiveTabBtn.classList.remove("active");
            }

            let targetSection;
            let targetTabBtn;

            switch (tabName) {
                case "booster":
                    targetSection = boosterSection;
                    targetTabBtn = boosterTab;
                    showLastBoosterSummary(); // Assurez-vous que le résumé du dernier booster est à jour
                    break;
                case "collection":
                    targetSection = collectionSection;
                    targetTabBtn = collectionTab;
                    updateCollection(); // Mettre à jour la collection lors de l'activation de l'onglet
                    break;
                case "shop":
                    targetSection = shopSection;
                    targetTabBtn = shopTab;
                    updateShop(); // Mettre à jour la boutique lors de l'activation de l'onglet
                    break;
                case "data":
                    targetSection = dataSection;
                    targetTabBtn = dataTab;
                    break;
                default:
                    return;
            }

            targetSection.classList.add("active");
            targetTabBtn.classList.add("active");
            currentActiveSection = targetSection;
            currentActiveTabBtn = targetTabBtn;
        }

        // --- Fonctions Login/Logout ---
        function login() {
            const code = userCodeInput.value.trim();
            if (code.length === 6 && /^\d+$/.test(code)) { // Valide 6 chiffres
                currentCode = code;
                loginSection.style.display = "none";
                appContent.style.display = "block";
                logoutBtn.style.display = "block";

                // Initialiser l'application pour l'utilisateur
                updateBoosterCount();
                showLastBoosterSummary();
                switchTab("booster"); // Afficher l'onglet booster par défaut
            } else {
                showMessage("Veuillez entrer un code à 6 chiffres.");
            }
        }

        function logout() {
            currentCode = null;
            loginSection.style.display = "flex"; // Réafficher la section de connexion
            appContent.style.display = "none";
            logoutBtn.style.display = "none";

            // Nettoyage de l'interface
            boosterCountSpan.textContent = '0';
            lastBoosterSummary.innerHTML = '';
            document.getElementById("collection-grid").innerHTML = '';
            dailyShopCardsContainer.innerHTML = '';
            duplicateSelectionContainer.innerHTML = '';
            shopMessage.textContent = '';
            buyShopCardBtn.disabled = true;

            // Réinitialiser les onglets
            if (currentActiveTabBtn) {
                currentActiveTabBtn.classList.remove("active");
            }
            boosterTab.classList.add("active"); // Remettre l'onglet Booster actif par défaut à la reconnexion
        }

        // --- Fonctions Import/Export de données ---
        function exportData() {
            if (!currentCode) {
                showMessage("Connectez-vous d'abord avant d'exporter.");
                return;
            }
            const key = getStorageKey();
            const data = localStorage.getItem(key);
            if (!data) {
                showMessage("Aucune donnée trouvée à exporter.");
                return;
            }

            const blob = new Blob([data], { type: "application/json" });
            const url = URL.createObjectURL(blob);

            const a = document.createElement("a");
            a.href = url;
            a.download = `souyette_data_${currentCode}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importDataFromFile(file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const imported = JSON.parse(event.target.result);
                    if (!currentCode) {
                        showMessage("Connectez-vous d'abord avant d'importer.");
                        return;
                    }

                    // Vérification minimale
                    if (!imported.collection || !imported.date) {
                        showMessage("Fichier invalide ou incomplet.");
                        return;
                    }

                    localStorage.setItem(getStorageKey(), JSON.stringify(imported));
                    showMessage("Importation réussie !");
                    updateBoosterCount();
                    updateCollection();
                    updateShop();
                    showLastBoosterSummary();
                } catch (err) {
                    showMessage("Erreur lors de l'importation. Fichier non valide.");
                }
            };
            reader.readAsText(file);
        }

        // --- Écouteurs d'Événements ---
        loginBtn.addEventListener("click", login);
        userCodeInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") login();
        });
        logoutBtn.addEventListener("click", logout);

        openOgBoosterBtn.addEventListener("click", () => openBooster("OG"));
        openPrBoosterBtn.addEventListener("click", () => openBooster("PR"));
        openTeBoosterBtn.addEventListener("click", () => openBooster("TE"));

        boosterTab.addEventListener("click", () => switchTab("booster"));
        collectionTab.addEventListener("click", () => switchTab("collection"));
        shopTab.addEventListener("click", () => switchTab("shop"));
        dataTab.addEventListener("click", () => switchTab("data"));

        buyShopCardBtn.addEventListener("click", buyShopCard);

        exportDataBtn.addEventListener("click", exportData);
        importFileInput.addEventListener("change", (event) => {
            if (event.target.files.length > 0) {
                importDataFromFile(event.target.files[0]);
            }
        });

        messageBoxOkBtn.addEventListener("click", () => {
            messageBoxOverlay.classList.remove('show');
        });

        // Détection de glissement (swipe) sur la carte agrandie
        expandedCardElement.addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        }, { passive: true });

        expandedCardElement.addEventListener('touchmove', (e) => {
            touchEndX = e.touches[0].clientX;
            touchEndY = e.touches[0].clientY;
        });

        expandedCardElement.addEventListener('touchend', () => {
            const dx = touchEndX - touchStartX;
            const dy = Math.abs(touchEndY - touchStartY);

            if (Math.abs(dx) > swipeThreshold && dy < swipeMaxY) {
                if (dx > 0) { // Glissement vers la droite (précédent)
                    navigateFullCard(-1);
                } else { // Glissement vers la gauche (suivant)
                    navigateFullCard(1);
                }
            }
            touchStartX = 0;
            touchEndX = 0;
            touchStartY = 0;
            touchEndY = 0;
        });

        // Simuler le glissement avec la souris pour le desktop
        expandedCardElement.addEventListener('mousedown', (e) => {
            isMouseDown = true;
            mouseStartX = e.clientX;
            expandedCardElement.style.cursor = 'grabbing';
        });

        expandedCardElement.addEventListener('mousemove', (e) => {
            if (!isMouseDown) return;
            mouseEndX = e.clientX;
        });

        expandedCardElement.addEventListener('mouseup', () => {
            isMouseDown = false;
            expandedCardElement.style.cursor = 'grab'; // Remet le curseur normal
            const dx = mouseEndX - mouseStartX;
            if (Math.abs(dx) > swipeThreshold) {
                if (dx > 0) { // Glissement vers la droite (précédent)
                    navigateFullCard(-1);
                } else { // Glissement vers la gauche (suivant)
                    navigateFullCard(1);
                }
            }
            mouseStartX = 0;
            mouseEndX = 0;
        });

        expandedCardElement.addEventListener('mouseleave', () => {
            if (isMouseDown) {
                isMouseDown = false;
                expandedCardElement.style.cursor = 'grab';
                mouseStartX = 0;
                mouseEndX = 0;
            }
        });


        // Écouteur de clic sur l'overlay pour le fermer (si le clic n'est pas sur la carte elle-même)
        fullCardOverlay.addEventListener("click", (event) => {
            // Si l'élément cliqué est l'overlay lui-même (et non un enfant comme la carte)
            if (event.target === fullCardOverlay) {
                fullCardOverlay.style.display = "none";
                // Nettoyer les classes d'animation résiduelles
                expandedCardElement.classList.remove('slide-enter-from-right', 'slide-enter-from-left', 'slide-leave-to-left', 'slide-leave-to-right');
            }
        });

        // Fermeture avec la touche Échap
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && fullCardOverlay.style.display === 'flex') {
                fullCardOverlay.style.display = 'none';
                expandedCardElement.classList.remove('slide-enter-from-right', 'slide-enter-from-left', 'slide-leave-to-left', 'slide-leave-to-right');
            }
        });


        // --- Initialisation au chargement de la page ---
        window.onload = () => {
            // Afficher le formulaire de connexion au démarrage
            loginSection.style.display = "flex";
            appContent.style.display = "none";
            logoutBtn.style.display = "none"; // S'assurer que le bouton de déconnexion est masqué

            // Initialiser les onglets, mais ne pas appeler switchTab si pas connecté
            boosterTab.classList.add("active"); // Garder l'onglet booster actif visuellement par défaut
        };
    </script>
</body>
</html>
